// test 

function start(){

  window.loadScript = function(url, callback) {
    var script = document.createElement("script");
    script.type = "text/javascript";

    // If the browser is Internet Explorer

    if (script.readyState){
      script.onreadystatechange = function() {
        if (script.readyState == "loaded" || script.readyState == "complete") {
          script.onreadystatechange = null;
          callback();
        }
      };

      // For any other browser
    } else {
      script.onload = function() {
        callback();
      };
    }
    script.src = url;
    document.getElementsByTagName("head")[0].appendChild(script);
  };



  window.checkAppInstalled = function(version) {
    window.verifystudentapps.is_product_option = true
    commonJS(version);
    cartPageJS(version);
    productPageJS(version);
  };


  window.commonJS = function($){
    window.verifystudentappsStart = function($) {
        if(window.verifystudentapps.page_type == "product"){
          //console.log('products try offline');
        }

        if(window.verifystudentapps.page_type == 'cart'){

          var identifier = getUrlParameter('identifier');

          if(identifier != false){

            $.ajax({
              type: 'POST',
              url: window.verifystudentapps.po_url+'/api/get-discount-code',
              data: {cart_url_array:JSON.stringify(window.verifystudentapps)},
              cache: false,
              crossDomain: true,
              dataType: 'json',
              success: function(data){

                if(data.status){
                  var discount_code = data.discount_code;
                  var cart_url = $('form#cart, form.cart, form.Cart, form[action="/cart"]').attr('action');
                  if (/[?&]discount\s*=/.test(cart_url)) {
                    cart_url = cart_url.replace(/(?:([?&])discount\s*=[^?&]*)/, "$1discount=" + discount_code);
                  } else if (/\?/.test(cart_url)) {
                    cart_url = cart_url + "&discount=" + discount_code;
                  } else {
                    cart_url = cart_url + "?discount=" + discount_code;
                  }

                  var success_txt = data.success_txt;

                  $(".verify-student").append('<div class="discount-cd-field"><label for="discount">DISCOUNT CODE - APPLIED AT CHECKOUT</label> <input type="text" name="discount" value="'+discount_code+'" disabled="disabled" /> </div>');
                  $(".verify-student").append('<p>'+success_txt+' <a style="text-decoration:underline" href="https://all-around-me.de/">all-around-me.de</a></p>');
      
                  // append discount code on cart action
                  $('form#cart, form.cart, form.Cart, form[action="/cart"]').attr('action', cart_url);
                } else {
                  console.log('Something went wrong!');

                  var error_txt = data.error;
                  $(".verify-student").append('<p>'+error_txt+'</p>');
                }
              }
            });
          } else {
            $.ajax({
              type: 'GET',
              url: window.verifystudentapps.po_url+'/api/button-display?shop_url='+window.verifystudentapps.store_id,
              cache: false,
              crossDomain: true,
              success: function(data){
                //console.log(data)
                $(".verify-student").html(data)
              }
            });
          }
        }
    }
    verifystudentappsStart($);
  }


  window.cartPageJS = function($){
    // When user enter the phone_number.
    $(document).on('keypress', '.verifystudentapps_discount_code', function(e){
      if(e.which == 13){
        $(".verifystudentapps_discount_button").click();
      }

      if(e.which === 32){
        return false;
      }
    });
  }

  window.productPageJS = function($){
    // product page code
  }
}

start();

if (typeof window.verifystudentapps !== 'undefined'){
  if ((typeof(jQuery) == 'undefined') || (parseInt(jQuery.fn.jquery) == 3 && parseFloat(jQuery.fn.jquery.replace(/^1\./,"")) < 2.1)) {
    loadScript('//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js', function() {
      jQuery321 = jQuery.noConflict(true);
      checkAppInstalled(jQuery321);
    });
  }else{  
    checkAppInstalled(jQuery);
  }
}


function getUrlParameter(sParam) {
  var sPageURL = window.location.search.substring(1),
      sURLVariables = sPageURL.split('&'),
      sParameterName,
      i;

  for (i = 0; i < sURLVariables.length; i++) {
      sParameterName = sURLVariables[i].split('=');
      if (sParameterName[0] === sParam) {
          return typeof sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
      }
  }
  return false;
};